# This file was generated using Kotlin DSL (.github/workflows/src.main.kts).
# If you want to modify the workflow, please change the Kotlin file and regenerate this YAML file.
# Generated with https://github.com/typesafegithub/github-workflows-kt

name: 'Release'
on:
  push:
    tags:
      - 'v*'
permissions:
  actions: 'write'
  contents: 'write'
jobs:
  create-release:
    name: 'Create Release'
    runs-on: 'ubuntu-latest'
    outputs:
      uploadUrl: '${{ steps.step-4.outputs.upload_url }}'
      id: '${{ steps.step-4.outputs.id }}'
    steps:
      - id: 'step-0'
        uses: 'actions/checkout@v4'
      - id: 'step-1'
        name: 'Get Tag'
        uses: 'dawidd6/action-get-tag@v1'
      - id: 'step-2'
        uses: 'bhowell2/github-substring-action@v1.0.0'
        with:
          value: '${{ steps.step-1.outputs.tag }}'
          index_of_str: 'v'
          default_return_value: '${{ steps.step-1.outputs.tag }}'
      - id: 'step-3'
        name: 'Generate Release Notes'
        run: |-
          # Specify the file path
          FILE_PATH="ci-helper/release-template.md"
          
          # Read the file content
          file_content=$(cat "$FILE_PATH")
          
          modified_content="$file_content"
          # Replace 'string_to_find' with 'string_to_replace_with' in the content
          modified_content="${modified_content//\$GIT_TAG/${{ steps.step-1.outputs.tag }}}"
          modified_content="${modified_content//\$TAG_VERSION/${{ steps.step-2.outputs.substring }}}"
          
          # Output the result as a step output
          echo "result<<EOF" >> $GITHUB_OUTPUT
          echo "$modified_content" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      - id: 'step-4'
        name: 'Create Release'
        uses: 'softprops/action-gh-release@v1'
        with:
          body: '${{ steps.step-3.outputs.result }}'
          name: '${{ steps.step-2.outputs.substring }}'
          tag_name: '${{ steps.step-1.outputs.tag }}'
          draft: 'true'
          prerelease: '${{ contains(steps.step-1.outputs.tag, ''-'') }}'
        env:
          GITHUB_TOKEN: '${{ secrets.GITHUB_TOKEN }}'
  release_github-ubuntu-2404:
    name: 'Ubuntu 24.04 x86_64 (GitHub)'
    runs-on:
      - 'ubuntu-24.04'
    needs:
      - 'create-release'
    steps:
      - id: 'step-0'
        uses: 'actions/checkout@v4'
        with:
          submodules: 'recursive'
      - id: 'step-1'
        name: 'Get Tag'
        uses: 'dawidd6/action-get-tag@v1'
      - id: 'step-2'
        uses: 'bhowell2/github-substring-action@v1.0.0'
        with:
          value: '${{ steps.step-1.outputs.tag }}'
          index_of_str: 'v'
          default_return_value: '${{ steps.step-1.outputs.tag }}'
      - id: 'step-3'
        name: 'Free space for Ubuntu'
        uses: 'jlumbroso/free-disk-space@v1.3.1'
        with:
          android: 'false'
          large-packages: 'false'
          tool-cache: 'false'
      - id: 'step-4'
        name: 'Enable Swap'
        run: |-
          sudo fallocate -l 10G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
      - id: 'step-5'
        continue-on-error: true
        run: 'rm local.properties'
      - id: 'step-6'
        continue-on-error: true
        run: |-
          echo "ani.dandanplay.app.id=${{ secrets.DANDANPLAY_APP_ID }}" >> local.properties
          echo "ani.dandanplay.app.secret=${{ secrets.DANDANPLAY_APP_SECRET }}" >> local.properties
          echo "ani.sentry.dsn=${{ secrets.SENTRY_DSN }}" >> local.properties
          echo "kotlin.native.ignoreDisabledTargets=true" >> local.properties
      - id: 'step-7'
        continue-on-error: true
        run: |-
          echo "ani.enable.firebase=false" >> local.properties
      - id: 'step-8'
        name: 'Get JBR (Windows)'
        env:
          RUNNER_TOOL_CACHE: '${{ runner.tool_cache }}'
          JBR_URL: 'https://cache-redirector.jetbrains.com/intellij-jbr/jbrsdk_jcef-21.0.5-linux-x64-b750.29.tar.gz'
          JBR_CHECKSUM_URL: 'https://cache-redirector.jetbrains.com/intellij-jbr/jbrsdk_jcef-21.0.5-linux-x64-b750.29.tar.gz.checksum'
        shell: 'bash'
        run: 'python .github/workflows/download_jbr.py'
      - id: 'step-9'
        name: 'Setup JBR 21 for Ubuntu'
        uses: 'gmitch215/setup-java@6d2c5e1f82f180ae79f799f0ed6e3e5efb4e664d'
        with:
          java-version: '21'
          distribution: 'jdkfile'
          jdkFile: '${{ steps.step-8.outputs.jbrLocation }}'
        env:
          GITHUB_TOKEN: '${{ secrets.GITHUB_TOKEN }}'
      - id: 'step-10'
        name: 'Dump Local Properties'
        run: 'echo "jvm.toolchain.version=21" >> local.properties'
      - id: 'step-11'
        run: 'chmod -R 777 .'
      - id: 'step-12'
        name: 'Setup Gradle'
        uses: 'gradle/actions/setup-gradle@v3'
        with:
          cache-disabled: 'true'
      - id: 'step-13'
        name: 'Clean and download dependencies (Attempt #1)'
        continue-on-error: true
        timeout-minutes: 180
        run: './gradlew --scan "--stacktrace" "-Porg.gradle.daemon.idletimeout=60000" "-Dfile.encoding=UTF-8" "-Dorg.gradle.jvmargs=-Xmx8g -Dkotlin.daemon.jvm.options=-Xmx6g" "-Dkotlin.daemon.jvm.options=-Xmx6g"'
      - id: 'step-14'
        name: 'Clean and download dependencies (Attempt #2)'
        continue-on-error: false
        timeout-minutes: 180
        run: './gradlew --scan "--stacktrace" "-Porg.gradle.daemon.idletimeout=60000" "-Dfile.encoding=UTF-8" "-Dorg.gradle.jvmargs=-Xmx8g -Dkotlin.daemon.jvm.options=-Xmx6g" "-Dkotlin.daemon.jvm.options=-Xmx6g"'
        if: '${{ steps.step-13.outcome == ''failure'' }}'
      - id: 'step-15'
        name: 'Update Release Version Name (Attempt #1)'
        env:
          GITHUB_TOKEN: '${{ secrets.GITHUB_TOKEN }}'
          GITHUB_REPOSITORY: '${{ secrets.GITHUB_REPOSITORY }}'
          CI_RELEASE_ID: '${{ needs.create-release.outputs.id }}'
          CI_TAG: '${{ steps.step-1.outputs.tag }}'
        continue-on-error: true
        timeout-minutes: 180
        run: './gradlew updateReleaseVersionNameFromGit "--no-configuration-cache" "--scan" "-Porg.gradle.daemon.idletimeout=60000" "-Dfile.encoding=UTF-8" "-Dorg.gradle.jvmargs=-Xmx8g -Dkotlin.daemon.jvm.options=-Xmx6g" "-Dkotlin.daemon.jvm.options=-Xmx6g"'
      - id: 'step-16'
        name: 'Update Release Version Name (Attempt #2)'
        env:
          GITHUB_TOKEN: '${{ secrets.GITHUB_TOKEN }}'
          GITHUB_REPOSITORY: '${{ secrets.GITHUB_REPOSITORY }}'
          CI_RELEASE_ID: '${{ needs.create-release.outputs.id }}'
          CI_TAG: '${{ steps.step-1.outputs.tag }}'
        continue-on-error: false
        timeout-minutes: 180
        run: './gradlew updateReleaseVersionNameFromGit "--no-configuration-cache" "--scan" "-Porg.gradle.daemon.idletimeout=60000" "-Dfile.encoding=UTF-8" "-Dorg.gradle.jvmargs=-Xmx8g -Dkotlin.daemon.jvm.options=-Xmx6g" "-Dkotlin.daemon.jvm.options=-Xmx6g"'
        if: '${{ steps.step-15.outcome == ''failure'' }}'
      - id: 'step-17'
        name: 'Prepare signing key'
        continue-on-error: true
        uses: 'timheuer/base64-to-file@v1.1'
        with:
          fileName: 'android_signing_key'
          fileDir: './'
          encodedString: '${{ secrets.SIGNING_RELEASE_STOREFILE }}'

      - id: 'step-18'
        name: 'Generate Mock google-services.json'
        # 生成一个包含必要字段的“骨架”JSON，骗过插件的格式检查
        run: |
          echo '{"project_info":{"project_number":"0","project_id":"mock-project","storage_bucket":"mock-bucket"},"client":[{"client_info":{"mobilesdk_app_id":"1:123456789012:android:0000000000000000","android_client_info":{"package_name":"me.him188.ani"}},"api_key":[{"current_key":"mock_key"}]}]}' > ./app/android/google-services.json
      - id: 'step-19'
        name: 'Compile Kotlin (Attempt #1)'
        continue-on-error: true
        timeout-minutes: 180
        run: './gradlew compileKotlin compileCommonMainKotlinMetadata compileJvmMainKotlinMetadata compileKotlinDesktop compileKotlinMetadata "--scan" "-Porg.gradle.daemon.idletimeout=60000" "-Dfile.encoding=UTF-8" "-Dorg.gradle.jvmargs=-Xmx8g -Dkotlin.daemon.jvm.options=-Xmx6g" "-Dkotlin.daemon.jvm.options=-Xmx6g"'
      - id: 'step-20'
        name: 'Compile Kotlin (Attempt #2)'
        continue-on-error: false
        timeout-minutes: 180
        run: './gradlew compileKotlin compileCommonMainKotlinMetadata compileJvmMainKotlinMetadata compileKotlinDesktop compileKotlinMetadata "--scan" "-Porg.gradle.daemon.idletimeout=60000" "-Dfile.encoding=UTF-8" "-Dorg.gradle.jvmargs=-Xmx8g -Dkotlin.daemon.jvm.options=-Xmx6g" "-Dkotlin.daemon.jvm.options=-Xmx6g"'
        if: '${{ steps.step-19.outcome == ''failure'' }}'
      - id: 'step-21'
        name: 'Compile Kotlin Android (Attempt #1)'
        continue-on-error: true
        timeout-minutes: 180
        run: './gradlew compileReleaseKotlinAndroid "--scan" "-Porg.gradle.daemon.idletimeout=60000" "-Dfile.encoding=UTF-8" "-Dorg.gradle.jvmargs=-Xmx8g -Dkotlin.daemon.jvm.options=-Xmx6g" "-Dkotlin.daemon.jvm.options=-Xmx6g"'
      - id: 'step-22'
        name: 'Compile Kotlin Android (Attempt #2)'
        continue-on-error: false
        timeout-minutes: 180
        run: './gradlew compileReleaseKotlinAndroid "--scan" "-Porg.gradle.daemon.idletimeout=60000" "-Dfile.encoding=UTF-8" "-Dorg.gradle.jvmargs=-Xmx8g -Dkotlin.daemon.jvm.options=-Xmx6g" "-Dkotlin.daemon.jvm.options=-Xmx6g"'
        if: '${{ steps.step-21.outcome == ''failure'' }}'

      - id: 'step-37'
        name: 'Build Android Release APKs (Attempt #1)'
        env:
          signing_release_storeFileFromRoot: '${{ steps.step-17.outputs.filePath }}'
          signing_release_storePassword: '${{ secrets.SIGNING_RELEASE_STOREPASSWORD }}'
          signing_release_keyAlias: '${{ secrets.SIGNING_RELEASE_KEYALIAS }}'
          signing_release_keyPassword: '${{ secrets.SIGNING_RELEASE_KEYPASSWORD }}'
        continue-on-error: true
        timeout-minutes: 180
        run: './gradlew assembleRelease "--scan" "-Porg.gradle.daemon.idletimeout=60000" "-Dfile.encoding=UTF-8" "-Dorg.gradle.jvmargs=-Xmx8g -Dkotlin.daemon.jvm.options=-Xmx6g" "-Dkotlin.daemon.jvm.options=-Xmx6g" -x check -x test -x allTests -x desktopTest'

      - id: 'step-38'
        name: 'Build Android Release APKs (Attempt #2)'
        env:
          signing_release_storeFileFromRoot: '${{ steps.step-17.outputs.filePath }}'
          signing_release_storePassword: '${{ secrets.SIGNING_RELEASE_STOREPASSWORD }}'
          signing_release_keyAlias: '${{ secrets.SIGNING_RELEASE_KEYALIAS }}'
          signing_release_keyPassword: '${{ secrets.SIGNING_RELEASE_KEYPASSWORD }}'
        continue-on-error: false
        timeout-minutes: 180
        run: './gradlew assembleRelease "--scan" "-Porg.gradle.daemon.idletimeout=60000" "-Dfile.encoding=UTF-8" "-Dorg.gradle.jvmargs=-Xmx8g -Dkotlin.daemon.jvm.options=-Xmx6g" "-Dkotlin.daemon.jvm.options=-Xmx6g" -x check -x test -x allTests -x desktopTest'
        if: '${{ steps.step-37.outcome == ''failure'' }}'
      - id: 'step-39'
        name: 'Upload Android Release APK arm64-v8a (Attempt #1)'
        continue-on-error: true
        uses: 'actions/upload-artifact@v4'
        with:
          name: 'ani-android-arm64-v8a-release'
          path: 'app/android/build/outputs/apk/release/android-arm64-v8a-release.apk'
          overwrite: 'true'
      - id: 'step-40'
        name: 'Upload Android Release APK arm64-v8a (Attempt #2)'
        continue-on-error: true
        uses: 'actions/upload-artifact@v4'
        with:
          name: 'ani-android-arm64-v8a-release'
          path: 'app/android/build/outputs/apk/release/android-arm64-v8a-release.apk'
          overwrite: 'true'
        if: '${{ steps.step-39.outcome == ''failure'' }}'
      - id: 'step-41'
        name: 'Upload Android Release APK arm64-v8a (Attempt #3)'
        continue-on-error: false
        uses: 'actions/upload-artifact@v4'
        with:
          name: 'ani-android-arm64-v8a-release'
          path: 'app/android/build/outputs/apk/release/android-arm64-v8a-release.apk'
          overwrite: 'true'
        if: '${{ steps.step-40.outcome == ''failure'' }}'
      - id: 'step-42'
        name: 'Upload Android Release APK x86_64 (Attempt #1)'
        continue-on-error: true
        uses: 'actions/upload-artifact@v4'
        with:
          name: 'ani-android-x86_64-release'
          path: 'app/android/build/outputs/apk/release/android-x86_64-release.apk'
          overwrite: 'true'
      - id: 'step-43'
        name: 'Upload Android Release APK x86_64 (Attempt #2)'
        continue-on-error: true
        uses: 'actions/upload-artifact@v4'
        with:
          name: 'ani-android-x86_64-release'
          path: 'app/android/build/outputs/apk/release/android-x86_64-release.apk'
          overwrite: 'true'
        if: '${{ steps.step-42.outcome == ''failure'' }}'
      - id: 'step-44'
        name: 'Upload Android Release APK x86_64 (Attempt #3)'
        continue-on-error: false
        uses: 'actions/upload-artifact@v4'
        with:
          name: 'ani-android-x86_64-release'
          path: 'app/android/build/outputs/apk/release/android-x86_64-release.apk'
          overwrite: 'true'
        if: '${{ steps.step-43.outcome == ''failure'' }}'
      - id: 'step-45'
        name: 'Upload Android Release APK armeabi-v7a (Attempt #1)'
        continue-on-error: true
        uses: 'actions/upload-artifact@v4'
        with:
          name: 'ani-android-armeabi-v7a-release'
          path: 'app/android/build/outputs/apk/release/android-armeabi-v7a-release.apk'
          overwrite: 'true'
      - id: 'step-46'
        name: 'Upload Android Release APK armeabi-v7a (Attempt #2)'
        continue-on-error: true
        uses: 'actions/upload-artifact@v4'
        with:
          name: 'ani-android-armeabi-v7a-release'
          path: 'app/android/build/outputs/apk/release/android-armeabi-v7a-release.apk'
          overwrite: 'true'
        if: '${{ steps.step-45.outcome == ''failure'' }}'
      - id: 'step-47'
        name: 'Upload Android Release APK armeabi-v7a (Attempt #3)'
        continue-on-error: false
        uses: 'actions/upload-artifact@v4'
        with:
          name: 'ani-android-armeabi-v7a-release'
          path: 'app/android/build/outputs/apk/release/android-armeabi-v7a-release.apk'
          overwrite: 'true'
        if: '${{ steps.step-46.outcome == ''failure'' }}'
      - id: 'step-48'
        name: 'Upload Android Release APK universal (Attempt #1)'
        continue-on-error: true
        uses: 'actions/upload-artifact@v4'
        with:
          name: 'ani-android-universal-release'
          path: 'app/android/build/outputs/apk/release/android-universal-release.apk'
          overwrite: 'true'
      - id: 'step-49'
        name: 'Upload Android Release APK universal (Attempt #2)'
        continue-on-error: true
        uses: 'actions/upload-artifact@v4'
        with:
          name: 'ani-android-universal-release'
          path: 'app/android/build/outputs/apk/release/android-universal-release.apk'
          overwrite: 'true'
        if: '${{ steps.step-48.outcome == ''failure'' }}'
      - id: 'step-50'
        name: 'Upload Android Release APK universal (Attempt #3)'
        continue-on-error: false
        uses: 'actions/upload-artifact@v4'
        with:
          name: 'ani-android-universal-release'
          path: 'app/android/build/outputs/apk/release/android-universal-release.apk'
          overwrite: 'true'
        if: '${{ steps.step-49.outcome == ''failure'' }}'
      - id: 'step-51'
        name: 'Upload Android APK for Release (Attempt #1)'
        env:
          GITHUB_TOKEN: '${{ secrets.GITHUB_TOKEN }}'
          GITHUB_REPOSITORY: '${{ secrets.GITHUB_REPOSITORY }}'
          CI_RELEASE_ID: '${{ needs.create-release.outputs.id }}'
          CI_TAG: '${{ steps.step-1.outputs.tag }}'
          UPLOAD_TO_S3: 'false'
          AWS_ACCESS_KEY_ID: '${{ secrets.AWS_ACCESS_KEY_ID }}'
          AWS_SECRET_ACCESS_KEY: '${{ secrets.AWS_SECRET_ACCESS_KEY }}'
          AWS_BASEURL: '${{ secrets.AWS_BASEURL }}'
          AWS_REGION: '${{ secrets.AWS_REGION }}'
          AWS_BUCKET: '${{ secrets.AWS_BUCKET }}'
        continue-on-error: true
        timeout-minutes: 180
        run: './gradlew :ci-helper:uploadAndroidApk "--no-configuration-cache" "--scan" "-Porg.gradle.daemon.idletimeout=60000" "-Dfile.encoding=UTF-8" "-Dorg.gradle.jvmargs=-Xmx8g -Dkotlin.daemon.jvm.options=-Xmx6g" "-Dkotlin.daemon.jvm.options=-Xmx6g"'
      - id: 'step-52'
        name: 'Upload Android APK for Release (Attempt #2)'
        env:
          GITHUB_TOKEN: '${{ secrets.GITHUB_TOKEN }}'
          GITHUB_REPOSITORY: '${{ secrets.GITHUB_REPOSITORY }}'
          CI_RELEASE_ID: '${{ needs.create-release.outputs.id }}'
          CI_TAG: '${{ steps.step-1.outputs.tag }}'
          UPLOAD_TO_S3: 'false'
          AWS_ACCESS_KEY_ID: '${{ secrets.AWS_ACCESS_KEY_ID }}'
          AWS_SECRET_ACCESS_KEY: '${{ secrets.AWS_SECRET_ACCESS_KEY }}'
          AWS_BASEURL: '${{ secrets.AWS_BASEURL }}'
          AWS_REGION: '${{ secrets.AWS_REGION }}'
          AWS_BUCKET: '${{ secrets.AWS_BUCKET }}'
        continue-on-error: false
        timeout-minutes: 180
        run: './gradlew :ci-helper:uploadAndroidApk "--no-configuration-cache" "--scan" "-Porg.gradle.daemon.idletimeout=60000" "-Dfile.encoding=UTF-8" "-Dorg.gradle.jvmargs=-Xmx8g -Dkotlin.daemon.jvm.options=-Xmx6g" "-Dkotlin.daemon.jvm.options=-Xmx6g"'
        if: '${{ steps.step-51.outcome == ''failure'' }}'

